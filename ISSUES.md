# HmJapanesePhoneticAnalyzer の潜在的な問題点

このドキュメントは、`HmJapanesePhoneticAnalyzer` プロジェクト内に存在する潜在的な問題、バグ、および改善点をまとめたものです。

## 1. ビルドと依存関係の問題 (Build & Dependency Issues)

### 1.1. ハードコードされたSDKパス
- **問題点:** C#プロジェクトファイル (`.csproj`) に、Windows 8.1 SDKへのパスが絶対パスでハードコードされています。
- **影響:** 開発環境が異なる（例: SDKのインストール場所が違う、Windowsのバージョンが違う）場合、プロジェクトのビルドが失敗する可能性が非常に高いです。
- **改善案:** MSBuildの標準的な方法でSDKを自動的に検出するように、プロジェクトファイルの参照方法を修正すべきです。

### 1.2. 古い.NET Frameworkバージョン
- **問題点:** プロジェクトは `.NET Framework 4.5` をターゲットにしています。これは現在では古いバージョンです。
- **影響:** 最新の言語機能やパフォーマンス改善の恩恵を受けられません。
- **改善案:** `hmV8`マクロエンジンとの互換性を確認した上で、より新しい.NET Frameworkバージョン（例: 4.7.2や4.8）への更新を検討すべきです。

### 1.3. NuGetパッケージ管理の不使用
- **問題点:** プロジェクトは外部ライブラリ（`Windows.winmd`）を参照する際に、NuGetのようなパッケージ管理システムを使用していません。
- **影響:** 依存関係の管理が手動であり、更新や復元が困難です。
- **改善案:** 依存関係をNuGetで管理するように移行することを検討すべきです。

## 2. C#コードの問題 (C# Code Issues)

### 2.1. ステートフルなクラス設計
- **問題点:** `HmJapanesePhoneticAnalyzer` クラスは、処理の進捗を追跡するためにメンバー変数 (`m_text`, `m_char_ix`) を使用しており、ステートフル（状態を持つ）な設計になっています。
- **影響:** 同じインスタンスを複数回利用した場合に、予期せぬ挙動を引き起こす可能性があります。スレッドセーフでもありません。
- **改善案:** メソッド内でローカル変数を使用し、状態を持たない（ステートレスな）設計に変更することで、より堅牢なコードになります。

### 2.2. エラーハンドリングの不足
- **問題点:** `Windows.Globalization.JapanesePhoneticAnalyzer.GetWords` APIの呼び出しが `try...catch` ブロックで囲まれていません。
- **影響:** APIが利用できない環境（例: Windows 8より前のOS）で実行された場合や、APIが予期せぬエラーを返した場合に、DLLがクラッシュし、マクロ全体が停止する可能性があります。
- **改善案:** API呼び出しを `try...catch` で囲み、エラーが発生した場合には例外を適切に処理するか、呼び出し元（マクロ側）にエラー情報を返す仕組みを導入すべきです。

### 2.3. 誤解を招くプロパティ名
- **問題点:** `JapanesePhoneticAnalyzeData.IsPhraseStart` というプロパティ名は、実際には「その単語に漢字が含まれているかどうか」を判定しています。「フレーズの開始」という意味ではないため、名前と実態が一致していません。
- **影響:** コードの可読性を下げ、メンテナンスを困難にします。
- **改善案:** `ContainsKanji` のように、そのプロパティの役割を正確に表す名前に変更すべきです。

### 2.4. ドキュメントコメントの欠如
- **問題点:** publicなクラス `JapanesePhoneticAnalyzeData` やそのプロパティに、機能や目的を説明するXMLドキュメントコメントがありません。
- **影響:** このライブラリを他の開発者が利用する際に、APIの仕様を理解するのが困難です。
- **改善案:** publicなAPIには、標準的なXMLドキュメントコメントを追加すべきです。

## 3. TypeScript/マクロの問題 (TypeScript/Macro Issues)

### 3.1. 不安定な文章分割ロジック
- **問題点:** マクロは、Windows APIが長い文章を処理できないという制約を回避するため、正規表現を用いて文章を句読点などで分割しています。
- **影響:** この分割ロジックはヒューリスティック（経験則）に過ぎず、句読点を含まない長い文章など、特定のケースで正しく機能しない可能性があります。APIが許容する正確な文字数も不明です。
- **改善案:** 可能であれば、より安全な分割方法を検討するか、APIの制約についてドキュメントに明記し、利用者に注意を促すべきです。

### 3.2. .NETコンポーネント呼び出し時のエラーハンドリング不足
- **問題点:** TypeScriptコード内で、.NETコンポーネントの `GetJapanesePhoneticAnalyzeDataList` メソッドを呼び出す箇所が `try...catch` で保護されていません。
- **影響:** C#側で発生した例外がマクロ側でキャッチされず、マクロが予期せず停止する原因となります。
- **改善案:** .NETコンポーネントの呼び出しを `try...catch` で囲み、エラーメッセージをアウトプット枠に表示するなど、ユーザーフレンドリーなエラー処理を実装すべきです。

### 3.3. .NET連携機能に関するドキュメントの欠如
- **問題点:** `host.lib(clr, ...)` という `hmV8`エンジン独自の機能を使って.NET DLLを読み込んでいますが、この仕組みに関する説明がプロジェクト内に一切ありません。
- **影響:** プロジェクトのメンテナンスや改修を行う新規の開発者が、このコードがどのように動作しているのかを理解するのが非常に困難です。
- **改善案:** `README.md`などに、このプロジェクトが `hmV8` の.NET連携機能に依存していること、およびその基本的な使い方について記述すべきです。

## 4. 全般的なドキュメントの問題 (General Documentation Issues)

### 4.1. 空のドキュメントファイル
- **問題点:** `VS2017.md` というファイルが存在しますが、中身が空です。
- **影響:** ファイルの目的が不明で、混乱を招きます。
- **改善案:** ファイルに内容を記述するか、不要であれば削除すべきです。

### 4.2. ビルド手順の欠如
- **問題点:** ソースコードから `HmJapanesePhoneticAnalyzer.dll` や `HmJapanesePhoneticAnalyzer.mac` をビルドするための手順がどこにも記載されていません。
- **影響:** 開発者がソースコードを修正し、ビルドを試みることが困難です。
- **改善案:** `README.md` や開発者向けのドキュメントに、必要なツール（Visual Studioのバージョンなど）やビルド手順を明記すべきです。
